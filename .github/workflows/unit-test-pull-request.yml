# this job runs on pull request to main branch
# it runs all the unit tests for the flutter project
# it updates the codecov badge in readme and commits

name: Run Unit Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - name: üê¶ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: 3.24.1

      - name: Install dependencies
        run: |
          flutter pub get
          flutter gen-l10n

      - name: Run unit tests
        run: flutter test --coverage

      - name: Install coverage-badge
        run: |
          pip install coverage-badge

      - name: Generate coverage badge
        run: |
          cd coverage && coverage-badge -o coverage.svg && cd ..
          mv coverage/coverage.svg coverage.svg

      - name: Update README with new coverage badge
        run: |
          sed -i '' 's|!\[Coverage\](.*)|![Coverage](./coverage-badge.svg)|' README.md

      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add README.md coverage-badge.svg
          git commit -m 'Update code coverage badge'
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
